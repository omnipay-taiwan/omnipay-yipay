# YiPay 金流串接手冊

**版本 V1.1.0**

乙禾網絡有限公司
Yihe Network Co., Ltd.

---

## 修改歷程

| 版本 | 日期 | 修改內容 |
|------|------|----------|
| V1.0.0 | 2016-11-15 | 初版 |
| V1.0.1 | 2017-03-16 | 修正錯誤 |
| V1.0.2 | 2017-05-11 | 更新串接網址;付款方式新增 3D 交易參數 |
| V1.0.3 | 2018-04-23 | 新增超商代碼繳費 |
| V1.0.4 | 2018-09-05 | 新增信用卡付款成功時寄送 Email 通知功能 |
| V1.0.5 | 2018-12-11 | 新增超商代碼繳費成功時寄送 Email 通知功能 |
| V1.0.6 | 2019-03-12 | 新增 ATM 虛擬帳號繳款 |
| V1.0.7 | 2019-04-26 | 修正錯誤 |
| V1.0.8 | 2019-07-23 | 信用卡付款新增回傳卡號末四碼<br>調整信用卡付款背景回傳次數<br>超商代碼繳費截止日期限制修改為 1~3 天 |
| V1.0.9 | 2020-10-20 | 新增逾時及頁面有效時間參數 |
| V1.1.0 | 2023-12-14 | ATM 虛擬帳號繳款新增回傳繳款截止日期參數 |

---

## 目錄

- [1. 說明](#1-說明)
  - [1.1. 串接網址](#11-串接網址)
  - [1.2. 串接方式](#12-串接方式)
  - [1.3. 取得商家資料](#13-取得商家資料)
  - [1.4. 注意事項](#14-注意事項)
- [2. 信用卡付款](#2-信用卡付款)
  - [2.1. 傳送參數](#21-傳送參數)
  - [2.2. 回傳結果](#22-回傳結果)
  - [2.3. 背景回傳](#23-背景回傳)
  - [2.4. 逾時回傳](#24-逾時回傳)
- [3. 超商代碼繳費](#3-超商代碼繳費)
  - [3.1. 傳送參數](#31-傳送參數)
  - [3.2. 回傳交易內容](#32-回傳交易內容)
  - [3.3. 取消返回結果](#33-取消返回結果)
  - [3.4. 回傳結果](#34-回傳結果)
  - [3.5. 逾時回傳](#35-逾時回傳)
- [4. ATM 虛擬帳號繳款](#4-atm-虛擬帳號繳款)
  - [4.1. 傳送參數](#41-傳送參數)
  - [4.2. 回傳交易內容](#42-回傳交易內容)
  - [4.3. 取消返回結果](#43-取消返回結果)
  - [4.4. 回傳結果](#44-回傳結果)
  - [4.5. 逾時回傳](#45-逾時回傳)
- [附錄 A. 檢查碼產生方式](#附錄-a-檢查碼產生方式)
- [附錄 B. 交易狀態確認](#附錄-b-交易狀態確認)
- [附錄 C. 付款方式](#附錄-c-付款方式)
- [附錄 D. 錯誤狀態代碼](#附錄-d-錯誤狀態代碼)
- [附錄 E. 測試環境串接參數](#附錄-e-測試環境串接參數)

---

## 1. 說明

本文件將說明如何進行乙禾網絡金流服務串接。

### 1.1. 串接網址

**正式環境:** https://gateway.yipay.com.tw/payment

**測試環境:** https://gateway-test.yipay.com.tw/payment

### 1.2. 串接方式

乙禾網絡金流服務是以 HTTP Form POST 方式進行串接,由商家網站系統導至乙禾付款頁面,若商家系統非經由 POST 方式傳送參數至乙禾系統時一律拒絕交易。

### 1.3. 取得商家資料

商家於串接時會需要部分參數,包含商家編號、串接 Key 及 IV,相關資料可於乙禾網絡官網登入商家專區後取得。

乙禾網絡官網 https://www.yipay.com.tw → 登入商家專區 → 點選「串接設定」。

**串接設定頁面資訊:**
- 商家編號: 1604000006
- 串接 Key: zBaw7bzzD8K1THSGoIbev08xEJp5yzyeuv1MWJDR2L0=
- 串接 IV: YeQInQjfelvkBcWuyhWDAw==
- 可串接服務: 網路刷卡、網路 3D 刷卡、代繳繳費

若登入商家專區後無顯示「串接設定」之選項,請確認商家已有開啟可串接相關服務。另外請注意,此處取得參數的方式僅限正式環境,測試環境的參數請參閱《附錄 E. 測試環境串接參數》。

### 1.4. 注意事項

- 為了安全性及相容性問題,請勿在 iframe 中進行串接。
- 如商家網站系統為非 https 者,在返回至指定的網址時部分的瀏覽器可能會出現警告訊息。
- 請勿將商家的 Key、IV 等敏感性資料存放於網頁前端。
- 請以 UTF-8 編碼進行資料傳遞,乙禾系統回覆結果亦皆為 UTF-8 編碼。
- 測試環境中使用的商家資料參數請參閱《附錄 E. 測試環境串接參數》,請勿使用正式環境的資料以免出現異常。

---

## 2. 信用卡付款

### 2.1. 傳送參數

有紅色星號 * 者為必填參數。

| 序號 | 名稱 | 描述 | 型態 | 長度 | 說明 |
|------|------|------|------|------|------|
| 1 | merchantId * | 商家編號 | Int | 10 | 商家於乙禾系統的代號 |
| 2 | type * | 付款方式 | Int | 1 | 參閱《附錄 C. 付款方式》 |
| 3 | amount * | 交易金額 | Int | 8 | 大於 0 之正整數、不含小數點及逗號,僅限新台幣付款 |
| 4 | orderNo * | 商家訂單編號 | String | 20 | 商家自訂的訂單編號,為唯一值不可重複 |
| 5 | orderDescription * | 交易內容 | String | 200 | 消費者購買內容 |
| 6 | orderNote1 | 交易備註 1 | String | 200 | 商家自定義 |
| 7 | orderNote2 | 交易備註 2 | String | 200 | 商家自定義 |
| 8 | notificationEmail | 成功交易 Email 通知 | String | 200 | 當交易成功時將交易結果寄送至商家指定的 Email,若有多筆 Email 以分號「;」區隔。請注意此處為通知商家消費者已完成交易用 |
| 9 | returnURL * | 回傳網址 | String | 200 | 當交易完成後,系統會由付款頁面返回至商家的頁面,並一併將結果以 POST 方式回傳至該網址 |
| 10 | cancelURL | 取消返回網址 | String | 200 | 若填寫此參數時,於付款頁面上會顯示「取消付款返回商家網站」的連結,當消費者按下後會導回商家指定網址,並不帶入任何參數 |
| 11 | backgroundURL | 背景回傳網址 | String | 200 | 當交易完成後,系統會將交易結果以背景方式 POST 至該網址 |
| 12 | timeout | 逾時秒數 | Int | 5 | 單位為秒,消費者進入付款頁面停留超過指定秒數,送出交易時將會提示操作逾時並返回商家指定頁面。範圍為 90 ~ 28800,無限制者為 0。若商家欲使用此參數,則下列 timeoutURL 為必填 |
| 13 | validTime | 進入頁面有效時間 | String | 12 | 當消費者進入付款頁面時已超過此時間者,將提示已超過有效付款時間並返回商家指定頁面。格式為 yyyyMMddHHmm,例如 202001011330 代表 2020 年 01 月 01 日 13 點 30 分,無限制者免填寫。若商家欲使用此參數,則下列 timeoutURL 為必填 |
| 14 | timeoutURL | 逾時返回網址 | String | 200 | 交易逾時時返回商家指定頁面並由商家提示消費者重新進行交易。若上列 timeout 不為 0 或有填入 validTime 時則此參數為必填 |
| 15 | checkCode * | 檢查碼 | String | 40 | 參閱下方檢查碼組成參數 |

#### 2.1.1. 檢查碼組成參數(傳送)

傳送至乙禾系統之「檢查碼 checkCode」由以下參數依序組成,產生方式請參閱《附錄 A. 檢查碼產生方式》。

| 序號 | 名稱 | 描述 | 範例 |
|------|------|------|------|
| 1 | merchantId | 商家編號 | 1604000006 |
| 2 | amount | 交易金額 | 1500 |
| 3 | orderNo | 商家訂單編號 | YP2016111503353 |
| 4 | returnURL | 回傳網址 | https://gateway-test.yipay.com.tw/demo/return |
| 5 | cancelURL | 取消返回網址 | https://gateway-test.yipay.com.tw/demo/cancel |
| 6 | backgroundURL | 背景回傳網址 | https://gateway-test.yipay.com.tw/demo/background |

### 2.2. 回傳結果

當交易完成後,會以 POST 方式導頁至商家指定的「回傳網址 returnURL」,並包含以下的授權結果。

| 序號 | 名稱 | 描述 | 型態 | 說明 |
|------|------|------|------|------|
| 1 | merchantId | 商家編號 | Int | |
| 2 | type | 付款方式 | Int | 參閱《附錄 C. 付款方式》 |
| 3 | amount | 交易金額 | Int | |
| 4 | orderNo | 商家訂單編號 | String | 商家傳送至乙禾的自訂訂單編號 |
| 5 | transactionNo | 交易編號 | String | 乙禾系統的交易編號 |
| 6 | statusCode | 交易回覆代碼 | String | 00 代表成功,其餘皆為失敗 |
| 7 | statusMessage | 交易回覆訊息 | String | 授權代碼說明 |
| 8 | approvalCode | 授權碼 | String | |
| 9 | last4CardNumber | 卡號末四碼 | Int | 信用卡號末四碼 |
| 10 | checkCode | 檢查碼 | String | 參閱下方檢查碼組成參數 |

#### 2.2.1. 檢查碼組成參數(回傳)

回傳結果內的「檢查碼 checkCode」由以下參數依序組成,產生方式請參閱《附錄 A. 檢查碼產生方式》。

| 序號 | 名稱 | 描述 | 範例 |
|------|------|------|------|
| 1 | merchantId | 商家編號 | 1604000006 |
| 2 | amount | 交易金額 | 1500 |
| 3 | orderNo | 商家訂單編號 | YP2016111503353 |
| 4 | returnURL | 回傳網址 | https://gateway-test.yipay.com.tw/demo/return |
| 5 | cancelURL | 取消返回網址 | https://gateway-test.yipay.com.tw/demo/cancel |
| 6 | backgroundURL | 背景回傳網址 | https://gateway-test.yipay.com.tw/demo/background |
| 7 | transactionNo | 交易編號 | C0216111500000000001 |
| 8 | statusCode | 交易回覆代碼 | 00 |
| 9 | approvalCode | 授權碼 | 629540 |

### 2.3. 背景回傳

若商家有填寫「背景回傳網址 backgroundURL」,當交易完成時亦會一併將《2.2. 回傳結果》的內容 POST 至指定網址,商家於收到時請回傳「OK」以供乙禾系統紀錄,若未正確回傳「OK」者,乙禾系統將會排程每小時重新傳送,共計六次。

如果於背景回傳時發生異常,導致商家系統無正常接受到回傳結果時,商家可利用《附錄 B. 交易狀態確認》功能再次向乙禾系統驗證。

### 2.4. 逾時回傳

若商家有指定「逾時秒數 timeout」且當消費者超過指定時間才送出交易、或有指定「有效時間 validTime」且進入付款頁面已超過指定時間,此時會 POST 導回商家指定的頁面 timeoutURL,並包含以下參數。

| 序號 | 名稱 | 描述 | 型態 | 說明 |
|------|------|------|------|------|
| 1 | merchantId | 商家編號 | Int | |
| 2 | type | 付款方式 | Int | 參閱《附錄 C. 付款方式》 |
| 3 | amount | 交易金額 | Int | |
| 4 | orderNo | 商家訂單編號 | String | 商家傳送至乙禾的自訂訂單編號 |

---

## 3. 超商代碼繳費

### 3.1. 傳送參數

有紅色星號 * 者為必填參數。

| 序號 | 名稱 | 描述 | 型態 | 長度 | 說明 |
|------|------|------|------|------|------|
| 1 | merchantId * | 商家編號 | Int | 10 | 商家於乙禾系統的代號 |
| 2 | type * | 付款方式 | Int | 1 | 參閱《附錄 C. 付款方式》 |
| 3 | amount * | 交易金額 | Int | 5 | 2 萬元內之正整數、不含小數點及逗號,僅限新台幣付款 |
| 4 | orderNo * | 商家訂單編號 | String | 20 | 商家自訂的訂單編號,為唯一值不可重複 |
| 5 | orderDescription * | 交易內容 | String | 20 | 消費者購買商品簡述,顯示於繳款單上 |
| 6 | orderNote1 | 交易備註 1 | String | 20 | 商家自定義,顯示於繳款單上 |
| 7 | orderNote2 | 交易備註 2 | String | 20 | 商家自定義,顯示於繳款單上 |
| 8 | expirationDay | 繳款截止日期 | Int | 1 | 訂單繳款天數限制,範圍為 1~3 天,如未設定則預設為 2 天 |
| 9 | notificationEmail | 成功交易 Email 通知 | String | 200 | 當消費者於超商完成繳費時將交易結果寄送至商家指定的 Email,若有多筆 Email 以分號「;」區隔。請注意此處為通知商家消費者已完成繳費用 |
| 10 | returnURL * | 回傳網址 | String | 200 | 當消費者於超商完成繳費後,系統會將交易結果以背景方式 POST 至該網址 |
| 11 | cancelURL | 取消返回網址 | String | 200 | 若填寫此參數時,會於下列頁面上顯示「返回商家網站」的連結,消費者按下後會以 POST 方式導回<br>1. 乙禾付款頁面<br>2. 產生超商繳費代碼的結果頁面 |
| 12 | backgroundURL * | 背景回傳網址 | String | 200 | 當產生超商繳費代碼後,系統會將交易內容以背景方式 POST 方式回傳至該網址 |
| 13 | timeout | 逾時秒數 | Int | 5 | 單位為秒,消費者進入付款頁面停留超過指定秒數,送出交易時將會提示操作逾時並返回商家指定頁面。範圍為 90 ~ 28800,無限制者為 0。若商家欲使用此參數,則下列 timeoutURL 為必填 |
| 14 | validTime | 進入頁面有效時間 | String | 12 | 當消費者進入付款頁面時已超過此時間者,將提示已超過有效付款時間並返回商家指定頁面。格式為 yyyyMMddHHmm,例如 202001011330 代表 2020 年 01 月 01 日 13 點 30 分,無限制者免填寫。若商家欲使用此參數,則下列 timeoutURL 為必填 |
| 15 | timeoutURL | 逾時返回網址 | String | 200 | 交易逾時時返回商家指定頁面並由商家提示消費者重新進行交易。若上列 timeout 不為 0 或有填入 validTime 時則此參數為必填 |
| 16 | checkCode * | 檢查碼 | String | 40 | 參閱下方檢查碼組成參數 |

#### 3.1.1. 檢查碼組成參數(傳送)

傳送至乙禾系統之「檢查碼 checkCode」由以下參數依序組成,產生方式請參閱《附錄 A. 檢查碼產生方式》。

| 序號 | 名稱 | 描述 | 範例 |
|------|------|------|------|
| 1 | merchantId | 商家編號 | 1604000006 |
| 2 | amount | 交易金額 | 1500 |
| 3 | orderNo | 商家訂單編號 | YP2016111503353 |
| 4 | returnURL | 回傳網址 | https://gateway-test.yipay.com.tw/demo/return |
| 5 | cancelURL | 取消返回網址 | https://gateway-test.yipay.com.tw/demo/cancel |
| 6 | backgroundURL | 背景回傳網址 | https://gateway-test.yipay.com.tw/demo/background |

### 3.2. 回傳交易內容

當超商繳費代碼產生成功後,會以 POST 方式背景傳送以下的交易內容至商家指定的「背景回傳網址 backgroundURL」。

| 序號 | 名稱 | 描述 | 型態 | 說明 |
|------|------|------|------|------|
| 1 | merchantId | 商家編號 | Int | |
| 2 | type | 付款方式 | Int | 參閱《附錄 C. 付款方式》 |
| 3 | amount | 交易金額 | Int | |
| 4 | orderNo | 商家訂單編號 | String | 商家傳送至乙禾的自訂訂單編號 |
| 5 | transactionNo | 交易編號 | String | 乙禾系統的交易編號 |
| 6 | statusCode | 交易回覆代碼 | String | 00 代表產生成功,其餘皆為失敗 |
| 7 | pinCode | 繳費代碼 | String | 超商繳費代碼 |
| 8 | checkCode | 檢查碼 | String | 參閱下方檢查碼組成參數 |

#### 3.2.1. 檢查碼組成參數(回傳)

回傳結果內的「檢查碼 checkCode」由以下參數依序組成,產生方式請參閱《附錄 A. 檢查碼產生方式》。

| 序號 | 名稱 | 描述 | 範例 |
|------|------|------|------|
| 1 | merchantId | 商家編號 | 1604000006 |
| 2 | amount | 交易金額 | 1500 |
| 3 | orderNo | 商家訂單編號 | YP2016111503353 |
| 4 | returnURL | 回傳網址 | https://gateway-test.yipay.com.tw/demo/return |
| 5 | cancelURL | 取消返回網址 | https://gateway-test.yipay.com.tw/demo/cancel |
| 6 | backgroundURL | 背景回傳網址 | https://gateway-test.yipay.com.tw/demo/background |
| 7 | transactionNo | 交易編號 | C0216111500000000001 |
| 8 | statusCode | 交易回覆代碼 | 00 |
| 9 | pinCode | 繳費代碼 | 1550D0332H2902 |

### 3.3. 取消返回結果

當消費者按下「返回商家網站」時,會以 POST 方式導頁至商家指定的「取消返回網址 cancelURL」,若已取得繳費代碼時會包含以下參數。

| 序號 | 名稱 | 描述 | 型態 | 說明 |
|------|------|------|------|------|
| 1 | type | 付款方式 | Int | 參閱《附錄 C. 付款方式》 |
| 2 | orderNo | 商家訂單編號 | String | 商家傳送至乙禾的自訂訂單編號 |
| 3 | status | 返回狀態 | Int | 固定為 1,代表已產生超商代碼 |

### 3.4. 回傳結果

當消費者於超商櫃檯完成繳費後,系統會以 POST 方式背景傳送以下的交易結果至商家指定的「回傳網址 returnURL」。

| 序號 | 名稱 | 描述 | 型態 | 說明 |
|------|------|------|------|------|
| 1 | merchantId | 商家編號 | Int | |
| 2 | type | 付款方式 | Int | 參閱《附錄 C. 付款方式》 |
| 3 | amount | 交易金額 | Int | |
| 4 | orderNo | 商家訂單編號 | String | 商家傳送至乙禾的自訂訂單編號 |
| 5 | transactionNo | 交易編號 | String | 乙禾系統的交易編號 |
| 6 | statusCode | 交易回覆代碼 | String | 00 代表付款成功,其餘皆為失敗 |
| 7 | pinCode | 繳費代碼 | String | 超商繳費代碼 |
| 8 | checkCode | 檢查碼 | String | 參閱下方檢查碼組成參數 |

#### 3.4.1. 檢查碼組成參數(回傳)

回傳結果內的「檢查碼 checkCode」由以下參數依序組成,產生方式請參閱《附錄 A. 檢查碼產生方式》。

| 序號 | 名稱 | 描述 | 範例 |
|------|------|------|------|
| 1 | merchantId | 商家編號 | 1604000006 |
| 2 | amount | 交易金額 | 1500 |
| 3 | orderNo | 商家訂單編號 | YP2016111503353 |
| 4 | returnURL | 回傳網址 | https://gateway-test.yipay.com.tw/demo/return |
| 5 | cancelURL | 取消返回網址 | https://gateway-test.yipay.com.tw/demo/cancel |
| 6 | backgroundURL | 背景回傳網址 | https://gateway-test.yipay.com.tw/demo/background |
| 7 | transactionNo | 交易編號 | C0216111500000000001 |
| 8 | statusCode | 交易回覆代碼 | 00 |
| 9 | pinCode | 繳費代碼 | 1550D0332H2902 |

#### 3.4.2. 背景回傳注意事項

商家於收到時請回傳字串「OK」以供乙禾系統紀錄,若未正確回傳「OK」者,乙禾系統將會排程每小時重新傳送,共計六次。

如果於背景回傳時發生異常,導致商家系統無正常接受到回傳結果時,商家可利用《附錄 B. 交易狀態確認》功能再次向乙禾系統驗證。

### 3.5. 逾時回傳

若商家有指定「逾時秒數 timeout」且當消費者超過指定時間才送出交易、或有指定「有效時間 validTime」且進入付款頁面已超過指定時間,此時會 POST 導回商家指定的頁面 timeoutURL,並包含以下參數。

| 序號 | 名稱 | 描述 | 型態 | 說明 |
|------|------|------|------|------|
| 1 | merchantId | 商家編號 | Int | |
| 2 | type | 付款方式 | Int | 參閱《附錄 C. 付款方式》 |
| 3 | amount | 交易金額 | Int | |
| 4 | orderNo | 商家訂單編號 | String | 商家傳送至乙禾的自訂訂單編號 |

---

## 4. ATM 虛擬帳號繳款

### 4.1. 傳送參數

有紅色星號 * 者為必填參數。

| 序號 | 名稱 | 描述 | 型態 | 長度 | 說明 |
|------|------|------|------|------|------|
| 1 | merchantId * | 商家編號 | Int | 10 | 商家於乙禾系統的代號 |
| 2 | type * | 付款方式 | Int | 1 | 參閱《附錄 C. 付款方式》 |
| 3 | amount * | 交易金額 | Int | 5 | 5 萬元內之正整數、不含小數點及逗號,僅限新台幣付款 |
| 4 | orderNo * | 商家訂單編號 | String | 20 | 商家自訂的訂單編號,為唯一值不可重複 |
| 5 | orderDescription * | 交易內容 | String | 200 | 消費者購買內容 |
| 6 | orderNote1 | 交易備註 1 | String | 200 | 商家自定義 |
| 7 | orderNote2 | 交易備註 2 | String | 200 | 商家自定義 |
| 8 | expirationDay | 繳款截止日期 | Int | 1 | 訂單繳款天數限制,範圍為 1~7 天,如未設定則預設為 7 天 |
| 9 | notificationEmail | 成功交易 Email 通知 | String | 200 | 當消費者完成繳款時將交易結果寄送至商家指定的 Email,若有多筆 Email 以分號「;」區隔。請注意此處為通知商家消費者已完成繳款用 |
| 10 | returnURL * | 回傳網址 | String | 200 | 當消費者完成繳款後,系統會將交易結果以背景方式 POST 至該網址 |
| 11 | cancelURL | 取消返回網址 | String | 200 | 若填寫此參數時,會於下列頁面上顯示「返回商家網站」的連結,消費者按下後會以 POST 方式導回<br>1. 乙禾付款頁面<br>2. 產生繳款虛擬帳號的結果頁面 |
| 12 | backgroundURL * | 背景回傳網址 | String | 200 | 當產生虛擬帳號後,系統會將交易內容以背景方式 POST 方式回傳至該網址 |
| 13 | timeout | 逾時秒數 | Int | 5 | 單位為秒,消費者進入付款頁面停留超過指定秒數,送出交易時將會提示操作逾時並返回商家指定頁面。範圍為 90 ~ 28800,無限制者為 0。若商家欲使用此參數,則下列 timeoutURL 為必填 |
| 14 | validTime | 進入頁面有效時間 | String | 12 | 當消費者進入付款頁面時已超過此時間者,將提示已超過有效付款時間並返回商家指定頁面。格式為 yyyyMMddHHmm,例如 202001011330 代表 2020 年 01 月 01 日 13 點 30 分,無限制者免填寫。若商家欲使用此參數,則下列 timeoutURL 為必填 |
| 15 | timeoutURL | 逾時返回網址 | String | 200 | 交易逾時時返回商家指定頁面並由商家提示消費者重新進行交易。若上列 timeout 不為 0 或有填入 validTime 時則此參數為必填 |
| 16 | checkCode * | 檢查碼 | String | 40 | 參閱下方檢查碼組成參數 |

#### 4.1.1. 檢查碼組成參數(傳送)

傳送至乙禾系統之「檢查碼 checkCode」由以下參數依序組成,產生方式請參閱《附錄 A. 檢查碼產生方式》。

| 序號 | 名稱 | 描述 | 範例 |
|------|------|------|------|
| 1 | merchantId | 商家編號 | 1604000006 |
| 2 | amount | 交易金額 | 1500 |
| 3 | orderNo | 商家訂單編號 | YP2016111503353 |
| 4 | returnURL | 回傳網址 | https://gateway-test.yipay.com.tw/demo/return |
| 5 | cancelURL | 取消返回網址 | https://gateway-test.yipay.com.tw/demo/cancel |
| 6 | backgroundURL | 背景回傳網址 | https://gateway-test.yipay.com.tw/demo/background |

### 4.2. 回傳交易內容

當虛擬帳號產生成功後,會以 POST 方式背景傳送以下的交易內容至商家指定的「背景回傳網址 backgroundURL」。

| 序號 | 名稱 | 描述 | 型態 | 說明 |
|------|------|------|------|------|
| 1 | merchantId | 商家編號 | Int | |
| 2 | type | 付款方式 | Int | 參閱《附錄 C. 付款方式》 |
| 3 | amount | 交易金額 | Int | |
| 4 | orderNo | 商家訂單編號 | String | 商家傳送至乙禾的自訂訂單編號 |
| 5 | transactionNo | 交易編號 | String | 乙禾系統的交易編號 |
| 6 | statusCode | 交易回覆代碼 | String | 00 代表產生成功,其餘皆為失敗 |
| 7 | account | 繳款帳戶 | String | 虛擬帳號帳戶 |
| 8 | bankCode | 繳款銀行代碼 | String | |
| 9 | bankName | 繳款銀行名稱 | String | |
| 10 | bankBranchCode | 繳款分行代碼 | String | |
| 11 | bankBranchName | 繳款分行名稱 | String | |
| 12 | expirationDate | 繳款截止日期 | String | |
| 13 | checkCode | 檢查碼 | String | 參閱下方檢查碼組成參數 |

#### 4.2.1. 檢查碼組成參數(回傳)

回傳結果內的「檢查碼 checkCode」由以下參數依序組成,產生方式請參閱《附錄 A. 檢查碼產生方式》。

| 序號 | 名稱 | 描述 | 範例 |
|------|------|------|------|
| 1 | merchantId | 商家編號 | 1604000006 |
| 2 | amount | 交易金額 | 1500 |
| 3 | orderNo | 商家訂單編號 | YP2016111503353 |
| 4 | returnURL | 回傳網址 | https://gateway-test.yipay.com.tw/demo/return |
| 5 | cancelURL | 取消返回網址 | https://gateway-test.yipay.com.tw/demo/cancel |
| 6 | backgroundURL | 背景回傳網址 | https://gateway-test.yipay.com.tw/demo/background |
| 7 | transactionNo | 交易編號 | C0216111500000000001 |
| 8 | statusCode | 交易回覆代碼 | 00 |
| 9 | account | 繳款帳戶 | 63167185726653 |

### 4.3. 取消返回結果

當消費者按下「返回商家網站」時,會以 POST 方式導頁至商家指定的「取消返回網址 cancelURL」,若已取得虛擬帳號時會包含以下參數。

| 序號 | 名稱 | 描述 | 型態 | 說明 |
|------|------|------|------|------|
| 1 | type | 付款方式 | Int | 參閱《附錄 C. 付款方式》 |
| 2 | orderNo | 商家訂單編號 | String | 商家傳送至乙禾的自訂訂單編號 |
| 3 | status | 返回狀態 | Int | 固定為 1,代表已產生虛擬帳號 |

### 4.4. 回傳結果

當消費者完成轉帳繳款後,系統會以 POST 方式背景傳送以下的交易結果至商家指定的「回傳網址 returnURL」。

| 序號 | 名稱 | 描述 | 型態 | 說明 |
|------|------|------|------|------|
| 1 | merchantId | 商家編號 | Int | |
| 2 | type | 付款方式 | Int | 參閱《附錄 C. 付款方式》 |
| 3 | amount | 交易金額 | Int | |
| 4 | orderNo | 商家訂單編號 | String | 商家傳送至乙禾的自訂訂單編號 |
| 5 | transactionNo | 交易編號 | String | 乙禾系統的交易編號 |
| 6 | statusCode | 交易回覆代碼 | String | 00 代表繳款成功,其餘皆為失敗 |
| 7 | account | 繳款帳戶 | String | 虛擬帳號帳戶 |
| 8 | checkCode | 檢查碼 | String | 參閱下方檢查碼組成參數 |

#### 4.4.1. 檢查碼組成參數(回傳)

回傳結果內的「檢查碼 checkCode」由以下參數依序組成,產生方式請參閱《附錄 A. 檢查碼產生方式》。

| 序號 | 名稱 | 描述 | 範例 |
|------|------|------|------|
| 1 | merchantId | 商家編號 | 1604000006 |
| 2 | amount | 交易金額 | 1500 |
| 3 | orderNo | 商家訂單編號 | YP2016111503353 |
| 4 | returnURL | 回傳網址 | https://gateway-test.yipay.com.tw/demo/return |
| 5 | cancelURL | 取消返回網址 | https://gateway-test.yipay.com.tw/demo/cancel |
| 6 | backgroundURL | 背景回傳網址 | https://gateway-test.yipay.com.tw/demo/background |
| 7 | transactionNo | 交易編號 | C0216111500000000001 |
| 8 | statusCode | 交易回覆代碼 | 00 |
| 9 | account | 繳款帳戶 | 63167185726653 |

#### 4.4.2. 背景回傳注意事項

商家於收到時請回傳字串「OK」以供乙禾系統紀錄,若未正確回傳「OK」者,乙禾系統將會排程每小時重新傳送,共計六次。

如果於背景回傳時發生異常,導致商家系統無正常接受到回傳結果時,商家可利用《附錄 B. 交易狀態確認》功能再次向乙禾系統驗證。

### 4.5. 逾時回傳

若商家有指定「逾時秒數 timeout」且當消費者超過指定時間才送出交易、或有指定「有效時間 validTime」且進入付款頁面已超過指定時間,此時會 POST 導回商家指定的頁面 timeoutURL,並包含以下參數。

| 序號 | 名稱 | 描述 | 型態 | 說明 |
|------|------|------|------|------|
| 1 | merchantId | 商家編號 | Int | |
| 2 | type | 付款方式 | Int | 參閱《附錄 C. 付款方式》 |
| 3 | amount | 交易金額 | Int | |
| 4 | orderNo | 商家訂單編號 | String | 商家傳送至乙禾的自訂訂單編號 |

---

## 附錄 A. 檢查碼產生方式

在和乙禾系統進行資料傳遞時,為驗證資料正確性,因此需要使用檢查碼 checkCode 來檢核,以下將說明如何將參數轉換為檢查碼。

**注意:** 商家系統於收到乙禾系統回傳的 POST 內容時,請務必判斷檢查碼是否正確。

### 步驟 1、組成 JSON 字串

將所需參數以 UTF-8 編碼依照各表格中所示順序排列,轉成為 Object 結構的 JSON 字串,並去除各組 key/value 間的空格,注意不需額外加入跳脫字元,並確認所有 key/value 皆有雙引號。組成的 JSON 字串需完全符合以下範例:

```json
{"merchantId":"1604000006","amount":"1500","orderNo":"YP2016111503353","returnURL":"https://gateway-test.yipay.com.tw/demo/return","cancelURL":"https://gateway-test.yipay.com.tw/demo/cancel","backgroundURL":"https://gateway-test.yipay.com.tw/demo/background"}
```

### 步驟 2、AES 加密

接著將 JSON 字串以 AES-256-CBC 方式加密,使用的 Key 及 IV 請參閱《1.3. 取得商家資料》。加密後的結果為:

```
0YeMFLPTyLoS3x3JfxhYxZ00EZAWOrDO6AcuHRL6Fury7VYpamMPduyFvid9+fBC5v50vsbLYL3qpEtrf
xignAMQA1GvJSlnXxcVc12x0JbabIu33uXMLA6fwyWKfuR9UqVMo99PR/2iCPfo2OWx44ZHmXtL/KVazE
dleoLCGg0yiEjbhfbacrxYLGOMHN73oMeL8t2zYixAGZ7HFnoUSDhgC70+/KdIPEpoqFAUopNduI2Z2iQ
2X9XXGfIExvElui3w2N6UWOSgdEp15OxB2L+RpLX1dmDJeRWH7trAncnM3hoqmZGwYw9D4thHMkL8J2O1
GFiZo8na5RsDQkSLnsuRJ5DaK9kOX6NM8TgEiE8=
```

**注意:** Key 及 IV 為 Base64 編碼(encode)後的字串,使用前請先解碼(decode)。

### 步驟 3、SHA1

最後使用 SHA1 將加密結果做 hash 即可(大小寫皆可)。

```
39c57c59f2ee2c71278dc75eebb190e5b4145e1f
```

若對於 AES 加密使用有問題,可以參考範例程式,目前有提供 PHP、ASP.NET、C#、ASP、Python 等語言的範例,請於乙禾網絡網站下載:

乙禾網絡官網 https://www.yipay.com.tw → 客服中心 → 技術文件 → 「YiPay 金流串接手冊」。

---

## 附錄 B. 交易狀態確認

當商家系統未正常接收到乙禾系統回傳的串接結果時,可利用此功能再次向乙禾系統確認結果。請使用 HTTP POST 方式進行串接,此功能會直接回傳 JSON 格式的結果。請依商家需求自行決定是否串接此 API。

### B.1. 串接網址

**正式環境:** https://gateway.yipay.com.tw/paymentCheck

**測試環境:** https://gateway-test.yipay.com.tw/paymentCheck

### B.2. 傳送參數

所有參數皆為必填。

| 序號 | 名稱 | 描述 | 型態 | 長度 | 說明 |
|------|------|------|------|------|------|
| 1 | merchantId | 商家編號 | Int | 10 | 商家於乙禾系統的代號 |
| 2 | type | 付款方式 | Int | 1 | 參閱《附錄 C. 付款方式》 |
| 3 | amount | 交易金額 | Int | 8 | 大於 0 之正整數、不含小數點 |
| 4 | orderNo | 商家訂單編號 | String | 20 | 商家自訂的訂單編號 |
| 5 | checkCode | 檢查碼 | String | 40 | 參閱下方檢查碼組成參數 |

#### B.2.1. 檢查碼組成參數(傳送)

「檢查碼 checkCode」由以下參數依序組成,產生方式請參閱《附錄 A. 檢查碼產生方式》。

| 序號 | 名稱 | 描述 | 範例 |
|------|------|------|------|
| 1 | merchantId | 商家編號 | 1604000006 |
| 2 | amount | 交易金額 | 1500 |
| 3 | orderNo | 商家訂單編號 | YP2016111503353 |

### B.3. 回傳結果

查詢的結果會以 JSON 格式回傳以下內容:

| 序號 | 名稱 | 描述 | 型態 | 說明 |
|------|------|------|------|------|
| 1 | type | 付款方式 | Int | |
| 2 | amount | 交易金額 | Int | |
| 3 | orderNo | 商家訂單編號 | String | 商家傳送至乙禾的自訂訂單編號 |
| 4 | transactionNo | 交易編號 | String | 乙禾系統的交易編號 |
| 5 | transactionDate | 交易時間 | Datetime | |
| 6 | statusCode | 交易回覆代碼 | String | 00 代表成功、YC 代表取消、YR 代表退貨,其餘皆為失敗 |
| 7 | statusMessage | 交易回覆訊息 | String | 授權代碼說明 |
| 8 | approvalCode | 授權碼 | String | 非信用卡交易時為空白 |
| 9 | last4CardNumber | 卡號末四碼 | Int | 非信用卡交易時為空白 |
| 10 | checkCode | 檢查碼 | String | 參閱下方檢查碼組成參數 |

若查詢失敗時將只會回傳 statusCode 及 statusMessage,請參閱《附錄 D. 錯誤狀態代碼》。

#### B.3.1. 檢查碼組成參數(回傳)

「檢查碼 checkCode」由以下參數依序組成,產生方式請參閱《附錄 A. 檢查碼產生方式》。

| 序號 | 名稱 | 描述 | 範例 |
|------|------|------|------|
| 1 | merchantId | 商家編號 | 1604000006 |
| 2 | amount | 交易金額 | 1500 |
| 3 | orderNo | 商家訂單編號 | YP2016111503353 |
| 4 | transactionNo | 交易編號 | C0216111500000000001 |
| 5 | statusCode | 交易回覆代碼 | 00 |
| 6 | approvalCode | 授權碼 | 629540 |

---

## 附錄 C. 付款方式

商家在進行串接時,可選擇不同的付款方式,提供的付款方式如下:

| 值 | 說明 |
|----|------|
| 1 | 信用卡付款 |
| 2 | 信用卡 3D 付款 |
| 3 | 超商代碼繳費 |
| 4 | ATM 虛擬帳號繳款 |

如不確定可使用的付款方式為何,可於乙禾網絡官網登入商家專區 → 點選「串接設定」後顯示於「可串接服務」列表。

---

## 附錄 D. 錯誤狀態代碼

當商家在串接或消費者在進行付款流程時,可能會遇到部分由乙禾系統顯示的錯誤畫面,可參考下列的代碼對應表,如有疑問請聯絡乙禾網絡。

| 代碼 | 發生原因 |
|------|----------|
| 4000 | 非經由正常途徑進入 |
| 4001 | 傳入商家編號格式錯誤 |
| 4002 | 傳入付款方式錯誤 |
| 4003 | 傳入交易金額錯誤 |
| 4004 | 交易金額不得為 0 |
| 4005 | 商家訂單編號不得為空 |
| 4006 | 消費者手機號碼格式錯誤 |
| 4007 | 消費者 Email 格式錯誤 |
| 4008 | 回傳網址格式錯誤 |
| 4009 | 取消返回網址格式錯誤 |
| 4010 | 背景回傳網址格式錯誤 |
| 4011 | 檢查碼錯誤 |
| 4012 | 查詢商家資料失敗 |
| 4013 | 查無商家資料(請確認付款方式,或是否於測試環境誤用正式環境的資料) |
| 4014 | 查詢商家資料失敗 |
| 4015 | 查詢商家資料失敗 |
| 4016 | 商家帳號已關閉 |
| 4017 | 商家帳號合約到期 |
| 4018 | 商家服務關閉 |
| 4019 | 商家服務額度已滿 |
| 4020 | 商家合約已到期 |
| 4021 | 超過單筆交易上限 |
| 4022 | 超過月交易上限 |
| 4023 | 商家訂單編號已存在 |
| 4036 | 商家訂單編號已存在 |
| 4049 | 商家訂單編號已存在 |
| 4051 | 交易資料異常 |
| 4053 | 交易資料異常 |
| 4054 | 交易資料異常 |
| 4055 | 非經由正常途徑進入 |
| 4056 | 非經由正常途徑進入 |
| 4057 | 非經由正常途徑進入 |
| 4058 | 非經由正常途徑進入 |
| 4059 | 非經由正常途徑進入 |
| 4060 | 非經由正常途徑進入 |
| 4061 | 非經由正常途徑進入 |
| 4062 | 非經由正常途徑進入 |
| 4063 | 非經由正常途徑進入 |
| 4064 | 非經由正常途徑進入 |
| 4065 | 請從正確的連結進入 |
| 4066 | 商家編號格式錯誤 |
| 4067 | 不正確的付款方式 |
| 4068 | 交易金額錯誤 |
| 4069 | 交易金額需為大於 0 元的正整數 |
| 4070 | 不正確的商家訂單編號 |
| 4071 | 系統資料異常 |
| 4072 | 查無商家資料 |
| 4073 | 不正確的檢查碼 |
| 4074 | 系統資料異常 |
| 4075 | 查無交易資料 |
| 4076 | 非經由正常途徑進入 |
| 4077 | 非經由正常途徑進入 |
| 4078 | 非經由正常途徑進入 |
| 4079 | 非經由正常途徑進入 |
| 4080 | 非經由正常途徑進入 |
| 4081 | 非經由正常途徑進入 |
| 4082 | 交易資料異常 |
| 4083 | 交易資料異常 |
| 4084 | 非經由正常途徑進入 |
| 4085 | 非經由正常途徑進入 |
| 4086 | 交易資料異常 |
| 4087 | 交易內容字數長度超過 20 字 |
| 4088 | 交易備註 1 字數長度超過 10 字 |
| 4089 | 交易備註 2 字數長度超過 10 字 |
| 4090 | 超商代碼繳款截止日期錯誤 |
| 4091 | 交易資料異常 |
| 4093 | 交易資料異常 |
| 4094 | 交易資料異常 |
| 4106 | 交易金額需小於 2 萬元 |
| 4107 | 背景回傳網址格式錯誤 |
| 4108 | 交易內容不得為空 |
| 4109 | 成功交易通知 Email 格式錯誤 |
| 4110 | 查詢交易資料失敗 |
| 4111 | 查詢交易資料失敗 |
| 4112 | 背景回傳網址格式錯誤 |
| 4113 | 查詢 ATM 虛擬帳號失敗 |
| 4114 | 交易資料異常 |
| 4115 | 交易資料異常 |
| 4122 | ATM 虛擬帳號繳款截止日期錯誤 |
| 4123 | 商家訂單編號字數超過 20 字 |
| 4124 | 交易內容字數超過 200 字 |
| 4125 | 交易備註 1 字數長度超過 200 字 |
| 4126 | 交易備註 2 字數長度超過 200 字 |
| 4127 | 交易金額字數長度超過 8 字 |
| 4128 | 成功交易通知 Email 字數長度超過 200 字 |
| 4129 | 回傳網址字數長度超過 200 字 |
| 4130 | 取消返回網址字數長度超過 200 字 |
| 4131 | 背景回傳網址字數長度超過 200 字 |
| 4134 | 超過單筆交易上限(ATM 虛擬帳號) |
| 4135 | 超過單筆交易上限(超商付款) |
| 4136 | 查詢 3D 交易資料失敗 |
| 4137 | 查無 3D 交易資料 |
| 4138 | 逾時設定秒數需為數字 |
| 4139 | 逾時設定秒數範圍需為 90~28800 或 0 |
| 4140 | 設定逾時秒數時逾時返回網址不得為空 |
| 4141 | 逾時返回網址格式錯誤 |
| 4142 | 逾時返回網址字數長度超過 200 字 |
| 4143 | validTime 非有效的日期格式 |
| 4700 | 回傳網址不得使用 YiPAY domain |
| 4900 | 送出交易時已超過商家指定逾時秒數 |
| 4901 | 進入付款頁面時已超過商家指定有效時間 |
| 4902 | 重新進入付款頁面(重新整理、F5、上一頁等行為)時已超過系統有效時間(8 小時) |
| 4999 | 使用者取消付款 |

---

## 附錄 E. 測試環境串接參數

乙禾測試環境的串接參數皆為固定值,請使用以下的參數進行測試:

| 商家編號 | 1604000006 |
|----------|------------|
| **Key** | zBaw7bzzD8K1THSGoIbev08xEJp5yzyeuv1MWJDR2L0= |
| **IV** | YeQInQjfelvkBcWuyhWDAw== |

### E.1. 測試環境注意事項

- 自 2019 年起可使用一般卡號進行測試,唯仍須符合信用卡號規則。卡號最末碼為雙數者視為交易成功,單數者則為交易失敗。
- 信用卡有效日期只要大於測試時間的日期即可;安全碼只要輸入三位數字即可。
- 在測試環境進行信用卡串接時並不會真的向銀行取授權,請放心使用。
- 信用卡 3D 交易不接受舊版文件提供之測試卡號。
- 超商代碼繳費僅能取號,無提供繳款功能。
- ATM 虛擬帳號取得繳款帳戶後,請不要以任何方式進行繳款。
- 請勿使用本文件中列出的範例網址,以免造成串接時無法正確進行及接收結果。

---

**乙禾網絡有限公司**
Yihe Network Co., Ltd.
